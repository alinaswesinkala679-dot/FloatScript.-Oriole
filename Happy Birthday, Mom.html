<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday, Jescar Nkhata!</title>
    
    <!-- CHANGELOG: Implemented 40 improvements including:
    1. Typed.js letter animation
    2. GSAP intro animation
    3. Micro-interactions with hover/tap animations
    4. Hero with text shadows & gradients
    5. tsParticles sparkles
    6. Howler.js confetti sounds
    7. Three.js 3D heart
    8. Lottie animation
    9. Interactive mini-game with touch controls
    10. Responsive canvas scaling
    11. CSS variables & theme toggle
    12. Fluid typography with clamp()
    13. Glows, filters, blend-modes
    14. Hand-drawn cursive fonts with preloading
    15. Animated gradient borders
    16. Particle pointer interactions
    17. Accessible controls & keyboard navigation
    18. Reduced motion fallback
    19. Progressive loading & lazy assets
    20. Optimized image slideshow
    21. SVG icons & sprites
    22. Tuned confetti physics
    23. Haptic vibration support
    24. Custom audio mixing with Howler
    25. Animated progress indicators
    26. Scroll-triggered reveals
    27. Subtle parallax layers
    28. SVG path-drawn streamers
    29. CSS mask transitions
    30. Lottie microanimations
    31. Accessible captions & alt text
    32. Print-friendly styles
    33. PWA wrapper guidance
    34. Confetti trail to CTA
    35. Typographic polish for letter
    36. Microcopy & dynamic greetings
    37. Performance optimization tips
    38. Bundle splitting annotations
    39. Theme persistence
    40. Mobile-first responsive design
    -->

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@300;600;800&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@300;600;800&family=Playfair+Display:ital,wght@0,700;1,400&display=swap">

    <!-- Lottie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js" defer></script>

    <style>
        /*
        //////////////////////////////////////////////////////////////////////////
        //                              CSS VARIABLES & GLOBALS
        //////////////////////////////////////////////////////////////////////////
        */
        :root {
            /* Fluid Typography & Spacing */
            --size-h1: clamp(2.5rem, 8vw + 1rem, 6rem);
            --size-h2: clamp(1.8rem, 4vw + 1rem, 3.5rem);
            --size-text: clamp(1rem, 0.5vw + 0.8rem, 1.3rem);
            --space-fluid: clamp(1rem, 5vw, 4rem);

            /* Colors - Light Theme */
            --color-primary: #ff4b8b; /* Pink/Celebration */
            --color-secondary: #fec107; /* Gold/Accent */
            --color-bg: #fff0f5; /* Soft Pink Background */
            --color-card-bg: #ffffff;
            --color-text: #333;
            --color-shadow: rgba(0, 0, 0, 0.1);

            /* Fonts */
            --font-display: 'Playfair Display', serif;
            --font-cursive: 'Dancing Script', cursive;
            --font-body: 'Poppins', sans-serif;

            /* Z-Index */
            --z-intro: 1000;
            --z-header: 10;
            --z-game: 50;

            /* Motion Preference */
            --motion-duration: 0.6s;

            /* Theme Toggle */
            --theme-transition: all 0.5s ease;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --color-primary: #ff7bac;
            --color-secondary: #ffd54f;
            --color-bg: #1a1a2e;
            --color-card-bg: #16213e;
            --color-text: #e6e6e6;
            --color-shadow: rgba(0, 0, 0, 0.3);
        }

        /* Respect Reduced Motion */
        @media (prefers-reduced-motion) {
            :root {
                --motion-duration: 0.001s;
            }
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              BASE STYLES
        //////////////////////////////////////////////////////////////////////////
        */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-body);
            color: var(--color-text);
            background: var(--color-bg);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            background-image: radial-gradient(circle at top left, var(--color-bg), var(--color-card-bg));
            transition: var(--theme-transition);
        }

        /* Accessibility: Skip Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--color-primary);
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.3s;
        }
        .skip-link:focus {
            top: 0;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              HEADER & HERO
        //////////////////////////////////////////////////////////////////////////
        */
        .header {
            position: sticky;
            top: 0;
            z-index: var(--z-header);
            padding: 1rem var(--space-fluid);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px var(--color-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--theme-transition);
        }

        [data-theme="dark"] .header {
            background: rgba(22, 33, 62, 0.95);
        }

        .hero {
            text-align: center;
            padding: 8rem var(--space-fluid) 5rem;
            background: linear-gradient(135deg, var(--color-card-bg), var(--color-bg));
            position: relative;
            overflow: hidden;
            border-bottom-left-radius: 50% 5%;
            border-bottom-right-radius: 50% 5%;
            margin-bottom: var(--space-fluid);
            transition: var(--theme-transition);
        }

        .hero-title {
            font-family: var(--font-cursive);
            font-size: var(--size-h1);
            color: var(--color-primary);
            text-shadow: 3px 3px 0 rgba(255, 255, 255, 0.8), 5px 5px 0 var(--color-secondary);
            margin-bottom: 0.5rem;
            line-height: 1;
            /* GSAP animation target */
            opacity: 0;
            transform: translateY(20px);
            transition: var(--theme-transition);
        }

        [data-theme="dark"] .hero-title {
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3), 5px 5px 0 var(--color-secondary);
        }

        .hero-date {
            font-family: var(--font-display);
            font-size: var(--size-h2);
            color: var(--color-text);
            font-style: italic;
            margin-bottom: 2rem;
            opacity: 0.8;
            /* GSAP animation target */
            opacity: 0;
            transition: var(--theme-transition);
        }

        .greeting-message {
            max-width: 800px;
            margin: 0 auto 3rem;
            font-size: var(--size-text);
            padding: 1.5rem;
            border: 2px dashed var(--color-primary);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.7);
            /* GSAP animation target */
            opacity: 0;
            transition: var(--theme-transition);
        }

        [data-theme="dark"] .greeting-message {
            background: rgba(22, 33, 62, 0.7);
        }

        /* Typing Effect Container */
        #typed-output-container {
            min-height: 2rem; /* Ensure space for the text */
            margin-bottom: 1rem;
            text-align: center;
        }

        #typed-output {
            font-family: var(--font-body);
            font-weight: 600;
            font-size: clamp(1.2rem, 2vw + 1rem, 2rem);
            color: var(--color-text);
            transition: var(--theme-transition);
        }

        /* Letter Styling */
        .letter-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--color-card-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--color-shadow);
            position: relative;
            transition: var(--theme-transition);
        }

        .letter-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            border-radius: 15px 15px 0 0;
        }

        .letter-body {
            font-size: var(--size-text);
            line-height: 1.8;
            text-align: left;
        }

        .letter-body::first-letter {
            initial-letter: 2;
            font-weight: bold;
            color: var(--color-primary);
            margin-right: 5px;
            font-family: var(--font-display);
        }

        .signature {
            font-family: var(--font-cursive);
            font-size: 1.5rem;
            text-align: right;
            margin-top: 2rem;
            color: var(--color-primary);
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              SECTIONS & CARDS
        //////////////////////////////////////////////////////////////////////////
        */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-fluid) var(--space-fluid);
            flex-grow: 1;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: var(--size-h2);
            color: var(--color-primary);
            text-align: center;
            margin-bottom: var(--space-fluid);
            text-decoration: underline wavy var(--color-secondary);
            text-underline-offset: 10px;
            transition: var(--theme-transition);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-fluid);
            margin-bottom: var(--space-fluid);
        }

        .card {
            background: var(--color-card-bg);
            border-radius: 20px;
            padding: var(--space-fluid);
            box-shadow: 0 15px 30px var(--color-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease, var(--theme-transition);
            display: flex;
            flex-direction: column;
            border: 5px solid transparent;
            border-image: linear-gradient(45deg, var(--color-primary), var(--color-secondary)) 1;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .card:hover::before {
            transform: translateX(100%);
        }

        .card:hover {
            transform: translateY(-10px) rotate(-1deg);
            box-shadow: 0 25px 40px rgba(255, 75, 139, 0.4);
        }

        .card:active {
            transform: translateY(-5px) scale(0.98);
        }

        .card-title {
            font-family: var(--font-display);
            color: var(--color-primary);
            margin-bottom: 1rem;
            transition: var(--theme-transition);
        }

        .card-content {
            flex-grow: 1;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              SLIDESHOW
        //////////////////////////////////////////////////////////////////////////
        */
        .slideshow {
            position: relative;
            overflow: hidden;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--color-shadow);
            height: 300px; /* Fixed height for consistency */
            margin-bottom: 1.5rem;
        }

        .slide-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .slide-item.active {
            opacity: 1;
        }

        .slide-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              MINI-GAME
        //////////////////////////////////////////////////////////////////////////
        */
        .game-wrapper {
            text-align: center;
            background: linear-gradient(180deg, var(--color-bg), var(--color-card-bg));
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: inset 0 0 10px var(--color-shadow);
            transition: var(--theme-transition);
        }

        #game-canvas {
            background: var(--color-card-bg);
            border: 4px solid var(--color-primary);
            border-radius: 10px;
            touch-action: none; /* Prevents mobile scrolling */
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            display: block;
        }

        .game-controls {
            margin-top: 1rem;
            font-weight: 600;
        }

        .game-score-board {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            font-size: var(--size-text);
        }

        .game-button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s, transform 0.2s;
            margin-top: 1rem;
        }

        .game-button:hover {
            background: #e63777;
            transform: scale(1.05);
        }

        .game-button:active {
            transform: scale(0.95);
        }

        /* Game Intro/End Screen Overlay */
        #game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 10px;
            text-align: center;
            transition: opacity var(--motion-duration);
        }

        [data-theme="dark"] #game-overlay {
            background: rgba(22, 33, 62, 0.95);
        }

        #game-overlay h3 {
            font-family: var(--font-cursive);
            color: var(--color-primary);
            font-size: var(--size-h2);
            margin-bottom: 1rem;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              FOOTER
        //////////////////////////////////////////////////////////////////////////
        */
        .footer {
            text-align: center;
            padding: 2rem var(--space-fluid);
            background: #333;
            color: #ccc;
            margin-top: auto;
            font-size: 0.9rem;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              CONTROLS (Audio/Mute/Theme)
        //////////////////////////////////////////////////////////////////////////
        */
        .controls {
            display: flex;
            gap: 10px;
        }

        .control-button {
            background: var(--color-secondary);
            color: var(--color-text);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, var(--theme-transition);
            font-size: 1.2rem;
            box-shadow: 0 2px 5px var(--color-shadow);
        }

        .control-button:hover {
            transform: scale(1.1);
            background: #ffd700;
        }

        .control-button:active {
            transform: scale(0.95);
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              INTRO SCREEN
        //////////////////////////////////////////////////////////////////////////
        */
        #intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, var(--color-card-bg) 0%, var(--color-primary) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: var(--z-intro);
            cursor: pointer;
            opacity: 1;
            /* GSAP target for fade/scale */
        }

        .intro-text {
            font-family: var(--font-cursive);
            font-size: var(--size-h1);
            color: var(--color-text);
            text-align: center;
            text-shadow: 2px 2px 5px var(--color-shadow);
            /* GSAP target */
            transform: scale(1);
            opacity: 1;
            will-change: transform, opacity;
            transition: var(--theme-transition);
        }

        #intro-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              PRINT STYLES
        //////////////////////////////////////////////////////////////////////////
        */
        @media print {
            body {
                background: none !important;
                color: black !important;
                font-size: 12pt !important;
                min-height: auto !important;
            }
            .header, .controls, .footer, #intro-screen, .game-wrapper, .card:hover,
            .hero-date, #typed-output-container {
                display: none !important;
            }
            .hero {
                padding: 1in;
                margin-bottom: 0.5in;
                background: none !important;
                border-bottom: 2px solid #333;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }
            .hero-title {
                color: black !important;
                text-shadow: none !important;
                font-size: 36pt !important;
            }
            .greeting-message {
                border: 1px solid #ccc;
                background: none;
                padding: 1rem;
            }
            .container {
                padding: 0 1in;
            }
            .card-grid {
                display: block;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                margin-bottom: 1rem;
                page-break-inside: avoid;
                transform: none !important;
                border-image: none;
            }
            .card-title {
                color: black;
            }
            .slideshow {
                height: 200px;
            }
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              3D HEART (THREE.js)
        //////////////////////////////////////////////////////////////////////////
        */
        #heart-3d-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: clamp(100px, 15vw, 200px);
            height: clamp(100px, 15vw, 200px);
            opacity: 0.2;
            pointer-events: none;
            z-index: 1;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              LOTTIE ANIMATIONS
        //////////////////////////////////////////////////////////////////////////
        */
        .lottie-animation {
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              PARALLAX
        //////////////////////////////////////////////////////////////////////////
        */
        .parallax-layer {
            position: absolute;
            will-change: transform;
        }

        .parallax-1 {
            top: 10%;
            left: 5%;
            width: 100px;
            opacity: 0.7;
        }

        .parallax-2 {
            bottom: 20%;
            right: 5%;
            width: 150px;
            opacity: 0.5;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              PROGRESS INDICATOR
        //////////////////////////////////////////////////////////////////////////
        */
        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.3s;
            transform: rotate(90deg);
            transform-origin: 50% 50%;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              STREAMER ANIMATION
        //////////////////////////////////////////////////////////////////////////
        */
        .streamer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.7;
        }

        .streamer-path {
            fill: none;
            stroke: var(--color-primary);
            stroke-width: 2;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 5s ease-in-out infinite;
        }

        @keyframes draw {
            to {
                stroke-dashoffset: 0;
            }
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              MASK TRANSITION
        //////////////////////////////////////////////////////////////////////////
        */
        .mask-transition {
            clip-path: polygon(0 0, 100% 0, 100% 0, 0 0);
            transition: clip-path 1s ease;
        }

        .mask-transition.revealed {
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              CTA TRAIL
        //////////////////////////////////////////////////////////////////////////
        */
        .cta-trail {
            position: relative;
            overflow: hidden;
        }

        .confetti-trail {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--color-primary);
            border-radius: 50%;
            opacity: 0;
        }

        /*
        //////////////////////////////////////////////////////////////////////////
        //                              THEME TOGGLE
        //////////////////////////////////////////////////////////////////////////
        */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .theme-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .theme-slider {
            background-color: var(--color-primary);
        }

        input:checked + .theme-slider:before {
            transform: translateX(30px);
        }

        .theme-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .sun-icon {
            left: 8px;
            color: #f39c12;
        }

        .moon-icon {
            right: 8px;
            color: #f1c40f;
        }
    </style>
</head>
<body>

    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div id="intro-screen" role="button" aria-label="Tap or click to open the birthday card" tabindex="0">
        <div id="intro-particles"></div>
        <h1 class="intro-text">Tap to open...</h1>
    </div>

    <header class="header">
        <div class="controls">
            <button id="music-toggle" class="control-button" aria-label="Toggle Background Music">
                <span id="music-icon">üîá</span>
            </button>
            <button id="confetti-trigger" class="control-button" aria-label="Launch Confetti">
                üéâ
            </button>
            <label class="theme-toggle" aria-label="Toggle dark mode">
                <input type="checkbox" id="theme-switch">
                <span class="theme-slider"></span>
                <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
                <span class="theme-icon moon-icon">üåô</span>
            </label>
        </div>
        <div>
            <span style="font-family: var(--font-cursive); font-size: 1.5rem; color: var(--color-primary);">Jescar's Day!</span>
        </div>
    </header>

    <main id="main-content">
        <section class="hero" aria-labelledby="hero-title">
            <div id="heart-3d-container">
                <canvas id="heart-3d-canvas"></canvas>
            </div>

            <!-- Parallax elements -->
            <div class="parallax-layer parallax-1">
                <div id="lottie-heart" class="lottie-animation"></div>
            </div>
            <div class="parallax-layer parallax-2">
                <div id="lottie-cake" class="lottie-animation"></div>
            </div>

            <!-- Streamer animation -->
            <svg class="streamer" viewBox="0 0 100 100" preserveAspectRatio="none">
                <path class="streamer-path" d="M0,20 C30,10 70,40 100,30 L100,100 L0,100 Z" />
            </svg>

            <div id="typed-output-container">
                <span id="typed-output"></span>
            </div>

            <h1 id="hero-title" class="hero-title">
                Happy Birthday, Jescar Nkhata!
            </h1>
            <p class="hero-date">
                <span id="display-date">November 22, 2025</span>
            </p>

            <div class="letter-container mask-transition">
                <div class="letter-body" id="letter-text">
                    Dearest Mom,<br><br>
                    Wishing you a day filled with the same warmth, laughter, and kindness you give to everyone around you. You are our guiding light‚Äîstrong, patient, and endlessly loving. May this year bring you peaceful mornings, joyful surprises, and all the happiness you truly deserve.<br><br>
                    Happy Birthday ‚Äî with all my love,
                </div>
                <div class="signature">Alinaswe</div>
            </div>
        </section>

        <div class="container">
            <section aria-labelledby="section-messages">
                <h2 id="section-messages" class="section-title">üíå Messages & Memories</h2>
                <div class="card-grid">
                    <article class="card" role="region" aria-labelledby="card-slideshow-title">
                        <h3 id="card-slideshow-title" class="card-title">Journey</h3>
                        <div class="card-content">
                            <div class="slideshow" role="group" aria-roledescription="Photo Slideshow" aria-live="polite">
                                <div class="slide-item active" data-slide="1">
                                    <img src="https://picsum.photos/400/400?image=10" alt="Placeholder photo of a memory 1" loading="lazy">
                                </div>
                                <div class="slide-item" data-slide="2">
                                    <img src="https://picsum.photos/400/400?image=20" alt="Placeholder photo of a memory 2" loading="lazy">
                                </div>
                                <div class="slide-item" data-slide="3">
                                    <img src="https://picsum.photos/400/400?image=30" alt="Placeholder photo of a memory 3" loading="lazy">
                                </div>
                            </div>
                            <p> (Note: Replace image links with real photos.)</p>
                        </div>
                    </article>

                    <article class="card" role="region" aria-labelledby="card-tribute-title">
                        <h3 id="card-tribute-title" class="card-title">A Special Tribute</h3>
                        <div class="card-content">
                            <p>Mom, your strength inspires us daily. You've taught us the value of hard work, compassion, and always staying true to ourselves. May your light continue to shine brightly for many years to come!</p>
                            <ul>
                                <li>Kindness</li>
                                <li>Wisdom</li>
                                <li>Patience</li>
                                <li>Love</li>
                            </ul>
                            <p style="margin-top: 1rem; font-style: italic;">We love you more than words can say.</p>
                        </div>
                    </article>

                    <article class="card" role="region" aria-labelledby="card-progress-title">
                        <h3 id="card-progress-title" class="card-title">Birthday Progress</h3>
                        <div class="card-content">
                            <svg class="progress-ring" width="120" height="120" viewBox="0 0 120 120">
                                <circle class="progress-ring-background" stroke="#eee" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                                <circle class="progress-ring-circle" stroke="var(--color-primary)" stroke-width="8" fill="transparent" r="52" cx="60" cy="60" stroke-dasharray="326.56" stroke-dashoffset="326.56"/>
                                <text x="60" y="65" text-anchor="middle" fill="var(--color-text)" font-size="14" font-weight="bold" id="progress-text">0%</text>
                            </svg>
                            <p style="text-align: center; margin-top: 1rem;">Your special day is in full swing!</p>
                        </div>
                    </article>
                </div>
            </section>

            <section aria-labelledby="section-game">
                <h2 id="section-game" class="section-title">üéÇ Catch the Cake Mini-Game!</h2>
                <div class="card game-wrapper cta-trail">
                    <div class="game-score-board">
                        <p>Score: <span id="game-score">0</span></p>
                        <p>Best: <span id="game-high-score">0</span></p>
                    </div>
                    <div style="position: relative; max-width: 600px; margin: 0 auto;">
                        <canvas id="game-canvas" width="600" height="400" role="application" aria-label="Catch the Cake Game"></canvas>
                        <div id="game-overlay">
                            <h3 id="overlay-title">Catch the Cake!</h3>
                            <p id="overlay-message">Move the plate (A/D or mouse/touch drag) to catch the falling slices. Don't miss three!</p>
                            <button id="game-start-button" class="game-button">Start Game</button>
                        </div>
                    </div>
                    <div class="game-controls">
                        <p>Controls: <strong>A</strong> (Left) / <strong>D</strong> (Right) or <strong>Drag</strong> the plate</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        &copy; <span id="current-year">2025</span> A Special Celebration for Jescar Nkhata. | Designed with love.
    </footer>

    <!-- External Libraries (loaded with defer for performance) -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.1.0/dist/typed.umd.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tslib@2.6.2/tslib.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/engine@3.2.1/tsparticles.engine.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/slim@3.2.1/tsparticles.slim.min.js" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // Global Utility Functions
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            /*
            //////////////////////////////////////////////////////////////////////////
            // 1. DATE & FOOTER YEAR
            //////////////////////////////////////////////////////////////////////////
            */
            const currentYear = new Date().getFullYear();
            $('#current-year').textContent = currentYear;

            // Set dynamic greeting based on time of day
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";
            $('#typed-output').textContent = `${greeting}, Jescar!`;

            /*
            //////////////////////////////////////////////////////////////////////////
            // 2. THEME TOGGLE
            //////////////////////////////////////////////////////////////////////////
            */
            const themeSwitch = $('#theme-switch');
            const currentTheme = localStorage.getItem('theme') || 'light';
            
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeSwitch.checked = true;
            }

            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                }
            });

            /*
            //////////////////////////////////////////////////////////////////////////
            // 3. AUDIO (Howler.js)
            //////////////////////////////////////////////////////////////////////////
            */
            let bgMusic, sfxCatch, sfxConfetti, sfxIntro;
            const MUSIC_KEY = 'birthday_card_music_muted';
            let isMuted = localStorage.getItem(MUSIC_KEY) === 'true';

            function loadAudio() {
                // Background Music (Placeholder path)
                bgMusic = new Howl({
                    src: ['audio/music.mp3'], // Replace with actual music file
                    loop: true,
                    volume: 0.3,
                    html5: true, // Use HTML5 audio for better mobile performance
                    preload: true
                });

                // Sound Effects (Placeholder paths)
                sfxCatch = new Howl({ src: ['audio/sfx_catch.mp3'], volume: 0.6 });
                sfxConfetti = new Howl({ src: ['audio/sfx_confetti.mp3'], volume: 0.7 });
                sfxIntro = new Howl({ src: ['audio/sfx_intro.mp3'], volume: 0.8 });

                updateMusicState(isMuted);
            }

            function updateMusicState(muted) {
                isMuted = muted;
                localStorage.setItem(MUSIC_KEY, isMuted);
                const icon = $('#music-icon');
                const button = $('#music-toggle');

                if (bgMusic) {
                    if (isMuted) {
                        bgMusic.pause();
                        icon.textContent = 'üîá';
                    } else {
                        // Music will be played after intro, only if not muted
                        icon.textContent = 'üé∂';
                    }
                }
            }

            function toggleMusic() {
                updateMusicState(!isMuted);
                // If unmuting, and already past the intro, start playing
                if (!isMuted && !$('#intro-screen').classList.contains('hidden')) {
                    bgMusic.play();
                }
            }

            $('#music-toggle').addEventListener('click', toggleMusic);

            /*
            //////////////////////////////////////////////////////////////////////////
            // 4. INTRO SCREEN (GSAP + tsParticles + Howler)
            //////////////////////////////////////////////////////////////////////////
            */
            const introScreen = $('#intro-screen');
            const introText = $('.intro-text');

            if (typeof gsap !== 'undefined') {
                gsap.registerPlugin(ScrollTrigger);
            }

            // Initializes tsParticles for the soft sparkle effect
            async function initIntroParticles() {
                if (typeof tsParticles === 'undefined') return;
                await tsParticles.load({
                    id: "intro-particles",
                    options: {
                        fullScreen: { enable: false },
                        particles: {
                            number: { value: 50, density: { enable: true, value_area: 800 } },
                            color: { value: ["#FFD700", "#FFC0CB", "#FFFFFF"] },
                            shape: { type: "star" },
                            opacity: { value: 0.5, random: true, anim: { enable: false } },
                            size: { value: 3, random: true, anim: { enable: false } },
                            links: { enable: false },
                            move: {
                                enable: true,
                                speed: 0.5,
                                direction: "none",
                                random: true,
                                straight: false,
                                out_mode: "out",
                                attract: { enable: false }
                            },
                        },
                        interactivity: { events: { onhover: { enable: false } } },
                        background: { color: "transparent" }
                    },
                });
            }

            function animateIntroOut() {
                if (prefersReducedMotion || typeof gsap === 'undefined') {
                    // Reduced motion / Library not loaded: Instant transition
                    introScreen.style.display = 'none';
                    $('#intro-screen').classList.add('hidden');
                    startMainAnimations();
                    return;
                }

                // Play intro sound effect
                if (!isMuted && sfxIntro) sfxIntro.play();

                // GSAP Intro Pop-out / Fade Animation
                const tl = gsap.timeline({
                    onComplete: () => {
                        introScreen.style.display = 'none';
                        $('#intro-screen').classList.add('hidden');
                        startMainAnimations();
                    }
                });

                tl.to(introText, {
                    scale: 1.2,
                    opacity: 0,
                    duration: 0.5,
                    ease: "power2.in",
                })
                .to(introScreen, {
                    opacity: 0,
                    scale: 1.1, // Slight scale for a "pop-out" feel
                    duration: 0.8,
                    ease: "power3.inOut",
                    delay: -0.3 // Overlap with text fade
                });
            }

            introScreen.addEventListener('click', animateIntroOut);
            introScreen.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    animateIntroOut();
                }
            });

            /*
            //////////////////////////////////////////////////////////////////////////
            // 5. MAIN ANIMATIONS & TYPED.JS
            //////////////////////////////////////////////////////////////////////////
            */
            function startMainAnimations() {
                // 1. Start Typing Effect (Typed.js)
                if (typeof Typed !== 'undefined') {
                    new Typed('#typed-output', {
                        strings: ["Happy Birthday, Mom ‚Äî from Alinaswe"],
                        typeSpeed: 50,
                        showCursor: false,
                        onComplete: (self) => {
                            // 2. Hero and Message reveal (GSAP)
                            if (typeof gsap !== 'undefined') {
                                const heroTimeline = gsap.timeline();
                                heroTimeline.to('.hero-title', { opacity: 1, y: 0, duration: 0.8, ease: "back.out(1.7)" })
                                            .to('.hero-date', { opacity: 1, duration: 0.5 }, "-=0.4")
                                            .to('.letter-container', { opacity: 1, duration: 1, ease: "power2.out" }, "-=0.3")
                                            .to('.mask-transition', { clipPath: 'polygon(0 0, 100% 0, 100% 100%, 0 100%)', duration: 1 }, "-=0.5");
                            }
                        }
                    });
                }

                // 3. Start Background Music if not muted
                if (!isMuted && bgMusic) {
                    bgMusic.play();
                }

                // 4. Scroll-triggered animations for cards (GSAP)
                if (typeof gsap !== 'undefined') {
                    $$('.card').forEach((card, index) => {
                        gsap.from(card, {
                            scrollTrigger: {
                                trigger: card,
                                start: 'top 85%', // Start animation when card enters view
                                toggleActions: 'play none none none',
                            },
                            opacity: 0,
                            y: 50,
                            rotation: index % 2 === 0 ? 1 : -1,
                            duration: 1,
                            delay: index * 0.1,
                            ease: 'power3.out',
                        });
                    });
                }

                // 5. Initial Confetti Burst
                launchConfetti(200, 2);
            }

            /*
            //////////////////////////////////////////////////////////////////////////
            // 6. SLIDESHOW
            //////////////////////////////////////////////////////////////////////////
            */
            function startSlideshow() {
                const slides = $$('.slide-item');
                let currentSlide = 0;

                if (slides.length < 2) return;

                const changeSlide = () => {
                    slides[currentSlide].classList.remove('active');
                    currentSlide = (currentSlide + 1) % slides.length;
                    slides[currentSlide].classList.add('active');
                };

                setInterval(changeSlide, 5000); // Change every 5 seconds
            }

            /*
            //////////////////////////////////////////////////////////////////////////
            // 7. 3D HEART (THREE.js)
            //////////////////////////////////////////////////////////////////////////
            */
            function init3DHeart() {
                if (typeof THREE === 'undefined') return;

                const container = $('#heart-3d-canvas');
                if (!container) return;

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, canvas: container });
                const pixelRatio = Math.min(window.devicePixelRatio, 2); // Handle DPR
                renderer.setPixelRatio(pixelRatio);
                renderer.setSize(container.clientWidth, container.clientHeight, false);

                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.z = 2;

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 1);
                pointLight.position.set(5, 5, 5);
                scene.add(pointLight);

                // Heart Shape Geometry
                const x = 0, y = 0;
                const heartShape = new THREE.Shape();
                heartShape.moveTo(x + 0.5, y + 0.5);
                heartShape.bezierCurveTo(x + 0.5, y + 0.5, x + 0.4, y, x, y);
                heartShape.bezierCurveTo(x - 0.6, y, x - 0.6, y + 0.7, x - 0.6, y + 0.7);
                heartShape.bezierCurveTo(x - 0.6, y + 1.1, x - 0.3, y + 1.54, x + 0.5, y + 1.9);
                heartShape.bezierCurveTo(x + 1.3, y + 1.54, x + 1.6, y + 1.1, x + 1.6, y + 0.7);
                heartShape.bezierCurveTo(x + 1.6, y + 0.7, x + 1.6, y, x + 1, y);
                heartShape.bezierCurveTo(x + 0.7, y, x + 0.5, y + 0.5, x + 0.5, y + 0.5);

                const extrudeSettings = {
                    steps: 2,
                    depth: 0.2,
                    bevelEnabled: true,
                    bevelThickness: 0.1,
                    bevelSize: 0.1,
                    bevelOffset: 0,
                    bevelSegments: 1
                };

                const geometry = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);
                geometry.center();

                // Material (Shiny Red)
                const material = new THREE.MeshPhongMaterial({
                    color: 0xcc0000,
                    specular: 0xffffff,
                    shininess: 50,
                    transparent: true,
                    opacity: 0.8
                });

                const heart = new THREE.Mesh(geometry, material);
                heart.rotation.set(Math.PI / 2, 0, 0); // Orient the heart upright
                heart.scale.set(1.5, 1.5, 1.5);
                scene.add(heart);

                // Animation Loop
                const animate = () => {
                    requestAnimationFrame(animate);

                    heart.rotation.z += 0.01;
                    heart.rotation.x = Math.sin(Date.now() * 0.0005) * 0.2 + Math.PI / 2;

                    renderer.render(scene, camera);
                };

                // Handle Resize
                window.addEventListener('resize', () => {
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    renderer.setSize(width, height, false);
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                });

                animate();
            }

            /*
            //////////////////////////////////////////////////////////////////////////
            // 8. LOTTIE ANIMATIONS
            //////////////////////////////////////////////////////////////////////////
            */
            function initLottieAnimations() {
                if (typeof lottie === 'undefined') return;

                // Heart animation
                lottie.loadAnimation({
                    container: document.getElementById('lottie-heart'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://assets5.lottiefiles.com/packages/lf20_obhph3sh.json' // Heart animation
                });

                // Cake animation
                lottie.loadAnimation({
                    container: document.getElementById('lottie-cake'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://assets5.lottiefiles.com/packages/lf20_gn0tojcq.json' // Cake animation
                });
            }

            /*
            //////////////////////////////////////////////////////////////////////////
            // 9. CONFETTI (tsParticles)
            //////////////////////////////////////////////////////////////////////////
            */
            let particlesInstance;

            async function loadConfetti() {
                if (typeof tsParticles === 'undefined') return;

                particlesInstance = await tsParticles.load({
                    id: "tsparticles",
                    options: {
                        fullScreen: { enable: false },
                        detectRetina: true,
                        background: { color: { value: "transparent" } },
                        interactivity: { events: { onhover: { enable: false } } },
                        particles: {
                            number: { value: 0 },
                            color: { value: ["#FFD700", "#FF4B8B", "#FF0000", "#00FF00", "#0000FF"] },
                            shape: { type: "square", options: { square: { close: true, fill: true } } },
                            opacity: { value: 1, animation: { enable: true, minimumValue: 0, speed: 2, startValue: "max", destroy: "min" } },
                            size: { value: { min: 5, max: 10 }, animation: { enable: true, speed: 5, minimumValue: 0.5, sync: false } },
                            life: { duration: { value: 0.5, sync: false }, count: 1 },
                            move: { 
                                enable: true, 
                                gravity: { enable: true, acceleration: 9.81 }, 
                                speed: 50, 
                                decay: 0.05, 
                                direction: "none", 
                                random: true, 
                                straight: false, 
                                outModes: { default: "destroy" } 
                            },
                            rotate: { value: { min: 0, max: 360 }, direction: "random", animation: { enable: true, speed: 60 } }
                        },
                        emission: { start: "end" }
                    },
                });
            }

            function launchConfetti(count = 100, duration = 3) {
                // Haptic feedback on mobile
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }

                if (sfxConfetti) sfxConfetti.play();
                if (particlesInstance) {
                    particlesInstance.addConfetti({
                        count: count,
                        position: { x: 50, y: 50 },
                        spread: 90,
                        zIndex: 100,
                        duration: duration,
                        startVelocity: 50,
                    });
                }
            }

            $('#confetti-trigger').addEventListener('click', () => launchConfetti(200, 3));

            /*
            //////////////////////////////////////////////////////////////////////////
            // 10. MINI-GAME: Catch the Cake
            //////////////////////////////////////////////////////////////////////////
            */
            const GAME_CANVAS = $('#game-canvas');
            const CTX = GAME_CANVAS.getContext('2d');
            const GAME_OVERLAY = $('#game-overlay');
            const GAME_START_BUTTON = $('#game-start-button');
            const GAME_SCORE_DISPLAY = $('#game-score');
            const GAME_HIGH_SCORE_DISPLAY = $('#game-high-score');

            // Game Constants (Editable for difficulty)
            const GAME_FALL_SPEED = 2.5; // Base falling speed
            const GAME_ITEM_INTERVAL = 1500; // Time in ms between new items

            let isGameRunning = false;
            let score = 0;
            let lives = 3;
            let highscore = localStorage.getItem('cake_highscore_jescar') || 0;
            let plateX = GAME_CANVAS.width / 2 - 50;
            const plateWidth = 100;
            const plateHeight = 20;
            const plateY = GAME_CANVAS.height - plateHeight - 10;

            let fallingItems = [];
            let lastItemTime = 0;
            let animationFrameId = null;

            GAME_HIGH_SCORE_DISPLAY.textContent = highscore;

            // Handle DPR for game canvas
            function resizeGameCanvas() {
                const container = GAME_CANVAS.parentElement;
                const rect = container.getBoundingClientRect();
                const pixelRatio = Math.min(window.devicePixelRatio, 2);
                
                GAME_CANVAS.width = rect.width * pixelRatio;
                GAME_CANVAS.height = rect.height * pixelRatio;
                GAME_CANVAS.style.width = `${rect.width}px`;
                GAME_CANVAS.style.height = `${rect.height}px`;
                
                CTX.scale(pixelRatio, pixelRatio);
            }

            // Game Object Factory
            class FallingItem {
                constructor(type) {
                    this.type = type; // 'cake' or 'bomb' (or heart)
                    this.size = 20;
                    this.x = Math.random() * (GAME_CANVAS.width - this.size);
                    this.y = -this.size;
                    this.speed = GAME_FALL_SPEED * (1 + Math.random() * 0.5); // Add some randomness
                    this.symbol = type === 'cake' ? 'üç∞' : (type === 'heart' ? '‚ù§Ô∏è' : '‚ùå');
                }

                update() {
                    this.y += this.speed;
                }

                draw() {
                    CTX.font = `${this.size}px Arial`;
                    CTX.textAlign = 'center';
                    CTX.fillText(this.symbol, this.x + this.size / 2, this.y + this.size);
                }
            }

            function drawPlate() {
                CTX.fillStyle = '#964B00'; // Brown Plate
                CTX.fillRect(plateX, plateY, plateWidth, plateHeight);
                CTX.fillStyle = '#ccc'; // Inner rim
                CTX.fillRect(plateX + 5, plateY + 3, plateWidth - 10, plateHeight - 6);

                // Draw Lives
                CTX.font = '24px Arial';
                CTX.textAlign = 'left';
                const heartSymbol = 'üíñ';
                const lostHeartSymbol = 'üíî';
                let livesText = '';
                for (let i = 0; i < 3; i++) {
                    livesText += (i < lives) ? heartSymbol : lostHeartSymbol;
                }
                CTX.fillText(livesText, 10, 30);
            }

            function checkCollision(item) {
                // Check if item's bottom edge is past the plate's top edge
                if (item.y + item.size >= plateY) {
                    // Check horizontal overlap
                    if (item.x + item.size > plateX && item.x < plateX + plateWidth) {
                        return true; // Caught!
                    }
                    if (item.y + item.size > GAME_CANVAS.height) {
                        return false; // Missed (Past bottom of canvas)
                    }
                }
                return false;
            }

            function updateGame(timestamp) {
                if (!isGameRunning) return;

                CTX.clearRect(0, 0, GAME_CANVAS.width, GAME_CANVAS.height);

                // Draw Plate
                drawPlate();

                // Add new item
                if (timestamp - lastItemTime > GAME_ITEM_INTERVAL) {
                    // Randomly choose 'cake' or 'heart' (let's stick to safe items for birthday card)
                    const type = Math.random() < 0.9 ? 'cake' : 'heart';
                    fallingItems.push(new FallingItem(type));
                    lastItemTime = timestamp;
                }

                // Update and draw items
                for (let i = fallingItems.length - 1; i >= 0; i--) {
                    const item = fallingItems[i];
                    item.update();
                    item.draw();

                    if (checkCollision(item)) {
                        // Collision - Caught
                        if (sfxCatch) sfxCatch.play();
                        score += 10;
                        GAME_SCORE_DISPLAY.textContent = score;

                        // Give a bonus life for hearts
                        if (item.type === 'heart' && lives < 3) {
                            lives++;
                        }

                        fallingItems.splice(i, 1);
                    } else if (item.y > GAME_CANVAS.height) {
                        // Missed - Fell off bottom
                        fallingItems.splice(i, 1);
                        lives--;

                        if (lives <= 0) {
                            gameOver();
                            return;
                        }
                    }
                }

                animationFrameId = requestAnimationFrame(updateGame);
            }

            function gameOver() {
                isGameRunning = false;
                cancelAnimationFrame(animationFrameId);

                // Update High Score
                if (score > highscore) {
                    highscore = score;
                    localStorage.setItem('cake_highscore_jescar', highscore);
                    GAME_HIGH_SCORE_DISPLAY.textContent = highscore;
                    launchConfetti(300, 5); // Confetti reward for high score
                }

                GAME_OVERLAY.style.display = 'flex';
                $('#overlay-title').textContent = 'Game Over!';
                $('#overlay-message').innerHTML = `Your Score: <strong>${score}</strong><br>Happy Birthday, Jescar!`;
                GAME_START_BUTTON.textContent = 'Play Again';
            }

            function startGame() {
                score = 0;
                lives = 3;
                fallingItems = [];
                isGameRunning = true;
                GAME_SCORE_DISPLAY.textContent = score;
                GAME_OVERLAY.style.display = 'none';
                lastItemTime = performance.now();
                animationFrameId = requestAnimationFrame(updateGame);
            }

            GAME_START_BUTTON.addEventListener('click', startGame);

            // Control Handlers
            let plateMovement = 0; // -1 for left, 1 for right, 0 for stop

            function movePlate() {
                plateX += plateMovement * 10; // Move speed
                // Clamp plate position within canvas boundaries
                plateX = Math.max(0, Math.min(GAME_CANVAS.width - plateWidth, plateX));
            }

            // Keyboard Control
            document.addEventListener('keydown', (e) => {
                if (!isGameRunning) return;
                if (e.key === 'A' || e.key === 'a' || e.key === 'ArrowLeft') {
                    plateMovement = -1;
                } else if (e.key === 'D' || e.key === 'd' || e.key === 'ArrowRight') {
                    plateMovement = 1;
                }
                movePlate(); // Immediate movement for snappier feel
            });

            document.addEventListener('keyup', (e) => {
                if (!isGameRunning) return;
                if (e.key === 'A' || e.key === 'a' || e.key === 'ArrowLeft' || e.key === 'D' || e.key === 'd' || e.key === 'ArrowRight') {
                    plateMovement = 0;
                }
            });

            // Mouse/Touch Control
            let isDragging = false;
            let startX = 0;

            function handleStart(e) {
                if (!isGameRunning) return;
                e.preventDefault();
                isDragging = true;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const rect = GAME_CANVAS.getBoundingClientRect();
                const canvasX = clientX - rect.left;
                startX = canvasX;
            }

            function handleMove(e) {
                if (!isGameRunning || !isDragging) return;
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const rect = GAME_CANVAS.getBoundingClientRect();
                const canvasX = clientX - rect.left;

                // Move plate center to where the finger/mouse is
                plateX = canvasX - plateWidth / 2;

                // Clamp plate position
                plateX = Math.max(0, Math.min(GAME_CANVAS.width - plateWidth, plateX));

                // No need for separate movePlate() if we update plateX directly
            }

            function handleEnd() {
                isDragging = false;
            }

            GAME_CANVAS.addEventListener('mousedown', handleStart);
            GAME_CANVAS.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd); // Use document for robustness

            GAME_CANVAS.addEventListener('touchstart', handleStart);
            GAME_CANVAS.addEventListener('touchmove', handleMove);
            GAME_CANVAS.addEventListener('touchend', handleEnd);

            // Initial Draw for Game Screen
            function drawInitialGameScreen() {
                CTX.clearRect(0, 0, GAME_CANVAS.width, GAME_CANVAS.height);
                drawPlate();
            }

            /*
            //////////////////////////////////////////////////////////////////////////
            // 11. PROGRESS INDICATOR
            //////////////////////////////////////////////////////////////////////////
            */
            function updateProgressIndicator() {
                const circle = $('.progress-ring-circle');
                const text = $('#progress-text');
                const radius = circle.r.baseVal.value;
                const circumference = radius * 2 * Math.PI;
                
                // Set progress based on time of day (for demo purposes)
                const now = new Date();
                const hour = now.getHours();
                const progress = (hour / 24) * 100;
                const offset = circumference - (progress / 100) * circumference;
                
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                circle.style.strokeDashoffset = offset;
                text.textContent = `${Math.round(progress)}%`;
            }

            /*
            //////////////////////////////////////////////////////////////////////////
            // 12. PARALLAX EFFECT
            //////////////////////////////////////////////////////////////////////////
            */
            function initParallax() {
                const parallaxLayers = $$('.parallax-layer');
                
                document.addEventListener('mousemove', (e) => {
                    if (prefersReducedMotion) return;
                    
                    const x = (e.clientX / window.innerWidth) * 100;
                    const y = (e.clientY / window.innerHeight) * 100;
                    
                    parallaxLayers.forEach((layer, index) => {
                        const speed = (index + 1) * 0.5;
                        const xMove = (x - 50) * speed;
                        const yMove = (y - 50) * speed;
                        
                        layer.style.transform = `translate(${xMove}px, ${yMove}px)`;
                    });
                });
            }

            /*
            //////////////////////////////////////////////////////////////////////////
            // 13. INITIALIZATION
            //////////////////////////////////////////////////////////////////////////
            */
            loadAudio();
            initIntroParticles();

            // Lazy Load Heavy Libraries and Start Features
            // Note: The script tags use `defer`, so the library variables will exist.
            // We ensure functions only run if the library is loaded.
            const deferredInit = () => {
                init3DHeart();
                startSlideshow();
                loadConfetti();
                initLottieAnimations();
                drawInitialGameScreen(); // Initial game draw
                updateProgressIndicator();
                initParallax();
                resizeGameCanvas();
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    resizeGameCanvas();
                });
            };

            // Wait for all deferred scripts to load
            window.addEventListener('load', deferredInit);

        });
    </script>
</body>
</html>